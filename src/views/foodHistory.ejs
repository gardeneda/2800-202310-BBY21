<!DOCTYPE html>
<html lang="en">
	<head>
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1"
			charset="utf-8"
		/>
		<title>Log In</title>
		<link rel="icon" type="image/x-icon" href="/img/sugaraide-favicon.png">
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
			rel="stylesheet"
			integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ"
			crossorigin="anonymous"
		/>
		<script
			src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
			integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
			crossorigin="anonymous"
		></script>
		<!-- Font Awesome Script Connected to .Isaiah's Account -->
		<script
			src="https://kit.fontawesome.com/36e5d26d04.js"
			crossorigin="anonymous"
		></script>
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<title>My chart.js chart</title>

		<!--CSS-->
		<link rel="stylesheet" href="/css/foodHistory.css">
		<link rel="stylesheet" href="/css/global.css" />
	</head>
	
	<body>
		<%- include("templates/header") %>
		<!--temp css-->
		<div class="container mx-auto" style="margin-top: 75px">
		  <!-- <select id="chart-type">
			<option value="calories">Calories (kcal)</option>
			<option value="sugar">Sugar (g)</option>
		  </select> -->
		  <canvas id="myChart"></canvas>
		  <!--TEST-->
		  <table id="summaryTable" class="table table-striped">
			<thead>
				<tr>
					<th scope="col" id="tableTitle">Food</th>
					<th scope="col" id="tableTitle">Calories</th>
					<th scope="col" id="tableTitle">Sugar</th>
					<th scope="col" id="tableTitle">Carbs</th>
					<th scope="col" id="tableTitle">Protein</th>
					<th scope="col" id="tableTitle">Delete</th>

				</tr>
			</thead>
			<tbody id="tableEntries">
			<!-- Food data will be inserted here -->
			</tbody>
		</table>		
		  <!--TEST-->
		</div>
	  
		<script>
			let days = <%- JSON.stringify(days) %>;
		  
			let labels = Object.keys(days);
			let data = labels.map(day => days[day].totalCalories);
		  
			let ctx = document.getElementById('myChart').getContext('2d');
			let chart = new Chart(ctx, {
			  type: 'bar',
			  data: {
				labels: labels,
				datasets: [{
				  label: 'Total Calories',
				  data: data,
				  backgroundColor: 'rgba(75, 192, 192, 0.2)',
				  borderColor: 'rgba(75, 192, 192, 1)',
				//   backgroundColor: 'rgba(255, 99, 132, 0.2)',
				//   borderColor: 'rgba(255, 99, 132, 1)',
				  borderWidth: 1
				}]
			  },
			  options: {
				scales: {
				  y: {
					beginAtZero: true
				  }
				},
				//TEST-------
				onClick: handleClick
			  }
			});

			async function handleClick(evt) {
				var activePoints = chart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
				var firstPoint = activePoints[0];
				if (firstPoint) {
					var label = chart.data.labels[firstPoint.index];

					let foodData = await fetch(`/foodHistory/foodData?day=${label}`, {
					method: 'GET',
					headers: {
						'Content-Type': 'application/json'
					}
					})
					.then(res => res.json())
					.then(data => data.foodData); 
					// Make sure to extract foodData from the response

					// Create the table with this data
					createSummaryTable(foodData);
				}
				}

				function createSummaryTable(foodData) {
					let tableBody = document.getElementById('summaryTable').getElementsByTagName('tbody')[0];
					// Clear existing data
					tableBody.innerHTML = '';
					// Add new rows for each food item
					for (let food of foodData) {
					let newRow = tableBody.insertRow();

					newRow.innerHTML = `<td>${food.food}</td><td>${food.calories}</td>
					<td>${food.sugar}</td><td>${food.carbohydrates}</td>
					<td>${food.protein}</td>
					<td><button class="delete-btn" data-food-name="${food.food}" data-food-date="${food.date}">X</button></td>`;
					let deleteBtn = newRow.querySelector('.delete-btn');
					deleteBtn.addEventListener('click', handleDelete);
					}
				}
				//TEST-------

				async function handleDelete(evt) {
					let foodName = evt.target.getAttribute('data-food-name');
					let foodDate = evt.target.getAttribute('data-food-date');

					await fetch(`/foodHistory/foodDataByNameAndDate?food=${foodName}&date=${foodDate}`, {
						method: 'DELETE',
					});

					// // After successful deletion, re-fetch data or otherwise update your table
					
					window.location.reload();
				}

				//TEST-------
		  </script>
		  
		<%- include("templates/footer") %>
	  </body>
	  
</html>

